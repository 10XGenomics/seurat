---
title: "Seurat 5 Essential Commands"
output:
  html_document:
    theme: united
    df_print: kable
  pdf_document: default
date: 'Compiled: `r format(Sys.Date(), "%B %d, %Y")`'
---
***
```{r setup, include=FALSE}
all_times <- list()  # store the time for each chunk
knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      now <<- Sys.time()
    } else {
      res <- difftime(Sys.time(), now, units = "secs")
      all_times[[options$label]] <<- res
    }
  }
}))
knitr::opts_chunk$set(
  tidy = TRUE,
  tidy.opts = list(width.cutoff = 95),
  warning = FALSE,
  error = TRUE,
  message = FALSE,
  fig.width = 8,
  time_it = TRUE
)
```

Here, we describe important commands and functions to store, access, and process data using Seurat v5.

```{r loaddata}
library(Seurat)
library(SeuratData)
library(BPCells)
options(Seurat.object.assay.version = "v5")
```

The Assay5 object is able to support different matrix data structures to best suit particular analyses. The PBMC 3k dataset contains ~3,000 cells, which can easily be stored in-memory as a sparse `dgCMatrix`. On the other hand, it can be impractical in terms of memory and computation to store and concomitantly analyze millions of cells in-memory. Thus, the mouse brain dataset stores counts on-disk in an Assay5 object.

```{r matrix}
pbmc3k <- LoadData("pbmc3k")
mousebrain1m <- readRDS("/brahms/hartmana/vignette_data/1p3_million_mouse_brain.rds")

# Both are Assay5's
print(class(pbmc3k[["RNA"]]))
print(class(mousebrain1m[["RNA"]]))

# But different underlying data structures storing counts
print(class(LayerData(pbmc3k[["RNA"]], layer = "counts")))
print(class(LayerData(mousebrain1m[["RNA"]], layer = "counts")))
```

Despite the drastic difference in dataset size, the 1.3M cell dataset occupies a small memory footprint thanks to on-disk storage.

```{r}
print(paste("PBMC 3k contains", length(Cells(pbmc3k)), "cells"))
print(paste("Mouse brain 1.3M contains", length(Cells(mousebrain1m)), "cells"))

# Despite the mouse brain dataset containing 1.3 million cells, the assay is under 350Mbs in size due to on-disk storage
print(paste("PBMC 3k assay size:", format(object.size(pbmc3k[["RNA"]]), units = "Mb")))
print(paste("Mouse brain 1.3M assay size:", format(object.size(mousebrain1m[["RNA"]]), units = "Mb")))
```

We can also cast between `Assay` and `Assay5` objects with `as()`. Note that the `RNA` assay is an `Assay5` object.

```{r}
pbmc3k[["RNA3"]] <- as(object = pbmc3k[["RNA"]], Class = "Assay")

pbmc3k[["RNA5"]] <- as(object = pbmc3k[["RNA3"]], Class = "Assay5")
```

The `Seurat.object.assay.version` option can also be set to create `Assay5` or `Assay` objects when new Assays or Seurat objects are created. 

```{r}
# create v3 assays
options(Seurat.object.assay.version = "v3")
pbmc.data <- Read10X(data.dir = "/brahms/hartmana/vignette_data/pbmc3k/filtered_gene_bc_matrices/hg19/")
pbmc <- CreateSeuratObject(counts = pbmc.data)
print(class(pbmc[["RNA"]]))

# create v5 assays
options(Seurat.object.assay.version = "v5")
pbmc.data <- Read10X(data.dir = "/brahms/hartmana/vignette_data/pbmc3k/filtered_gene_bc_matrices/hg19/")
pbmc <- CreateSeuratObject(counts = pbmc.data)
print(class(pbmc[["RNA"]]))
```

Layers can be split based on metadata.

```{r}
pbmc$split.data <- sample(c("A", "B", "C"), size = ncol(pbmc), replace = TRUE)
pbmc[["RNA"]] <- split(x = pbmc[["RNA"]], f = pbmc$split.data)
Layers(pbmc[["RNA"]])
```

And then joined back together in a single layer.

```{r}
pbmc[["RNA"]] <- JoinLayers(pbmc[["RNA"]])
Layers(pbmc[["RNA"]])
```

New layers can be added to assays with the `$` symbol.

```{r}
Layers(pbmc[["RNA"]])
# create a new layer with a subset of cells and normalize
data.ss <- NormalizeData(pbmc[["RNA"]]$counts[, Cells(pbmc)[1:10]])
pbmc[["RNA"]]$data.subset <- data.ss
Layers(pbmc[["RNA"]])
```

Assay data can be accessed with `LayerData` or `FetchData` depending on the use case.

```{r}
# returns information in whichever format the layer is stored
# in this example, the counts layer is stored as a dgCMatrix
b.marker.counts <- LayerData(object = pbmc, layer = "counts")[c("MS4A1", "CD79A"), ]
b.marker.counts[, 1:30]

# returns information as a data.frame
b.marker.counts.df <- FetchData(object = pbmc, layer = "counts", vars = c("rna_MS4A1", "rna_CD79A"))
head(b.marker.counts.df)
```


