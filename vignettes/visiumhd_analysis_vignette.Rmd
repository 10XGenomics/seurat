---
title: "Analysis, visualization, and integration of Visium HD spatial datasets with Seurat"
output:
  html_document:
    theme: united
    df_print: kable
  pdf_document: default
date: 'Compiled: `r Sys.Date()`'
---

```{r setup, include=FALSE}
all_times <- list()  # store the time for each chunk
knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      now <<- Sys.time()
    } else {
      res <- difftime(Sys.time(), now, units = "secs")
      all_times[[options$label]] <<- res
    }
  }
}))
knitr::opts_chunk$set(
  tidy = TRUE,
  tidy.opts = list(width.cutoff = 95),
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  time_it = TRUE,
  error = TRUE
)
```

# Overview

```{r, eval=FALSE}
# packages required for Visium HD
install.packages("hdf5r")
install.packages("arrow")

remotes::install_github(repo = "satijalab/seurat", ref = "visium-hd")
```
```{r install, eval = FALSE}
library(Seurat)
library(SeuratData)
library(ggplot2)
library(patchwork)
library(dplyr)
```

# 10x Visium

## Dataset

```{r data}
localdir <- "/brahms/lis/visium_hd/mouse/new_mousebrain/" 
object <- Load10X_Spatial(data.dir = localdir, bin.size = c(8))
```

## Data preprocessing

```{r qc, fig.height=5}
p1 <- VlnPlot(object, features = 'nCount_Spatial.008um', pt.size = 0) + NoLegend()
p2 <- SpatialFeaturePlot(object, features = 'nCount_Spatial.008um') + theme(legend.position = "right")
p1 | p2
```

```{r preprocess}
DefaultAssay(object) <- "Spatial.008um"

object <- NormalizeData(object)
object <- FindVariableFeatures(object)
object <- ScaleData(object)
object <- RunPCA(object, reduction.name = "pca.Spatial.008um")
object <- FindNeighbors(object, reduction = "pca.Spatial.008um", dims = 1:30)
object <- FindClusters(object, resolution = 0.6, cluster.name = "seurat_cluster.008um")
object <- RunUMAP(object, reduction = "pca.Spatial.008um", reduction.name = "umap.Spatial.008um", dims = 1:30)
```

```{r dim.plots,fig.height=5}
Idents(object) <- "seurat_cluster.008um"
p1 <- DimPlot(object, reduction = "umap.Spatial.008um", label = T, repel=T) 
p2 <- SpatialDimPlot(object, , label = T, repel=T, label.size = 3) 
p1 | p2
```

## Sketching & clustering 

```{r sketching}
DefaultAssay(object) <- "Spatial.008um"
object <- SketchData(
  object = object,
  ncells = 50000,
  method = "LeverageScore",
  sketched.assay = "sketch"
)
```

```{r sketch.preprocess}
DefaultAssay(object) <- "sketch"
object <- FindVariableFeatures(object)
object <- ScaleData(object)
object <- RunPCA(object, assay="sketch", reduction.name = "pca.sketch", verbose = T)
object <- FindNeighbors(object, assay="sketch", reduction = "pca.sketch", dims = 1:30, verbose = T)
object <- FindClusters(object, cluster.name="seurat_cluster.sketched", resolution = 3, verbose = T)
object <- RunUMAP(object, reduction = "pca.sketch", reduction.name = "umap.sketch", return.model = T, dims = 1:30, verbose = T)
```

```{r project}
object <- ProjectData(
  object = object,
  assay = "Spatial.008um",
  full.reduction = "pca.008um",
  sketched.assay = "sketch",
  sketched.reduction = "pca.sketch",
  umap.model = "umap.sketch",
  dims = 1:50,
  refdata = list(seurat_cluster.projected = "seurat_cluster.sketched")
)
```
```{r project.plots}
Idents(object) <- "seurat_cluster.projected"
DefaultAssay(object) <- "Spatial.008um"

p1 <- DimPlot(object, reduction = "umap.sketch", label=T, repel=T)
p2 <- SpatialDimPlot(object, label=T, repel=T)
p1 | p2
```
```{r cluster.plot, fig.height = 10}
plot_cluster_grid <- function(object, ident) {
  Idents(object) <- ident
  num_clusters <- length(levels(object))
  num_cols <- ceiling(sqrt(num_clusters))
  cluster_chunks <- split(levels(object), ceiling(seq_along(levels(object)) / num_cols))
  
  combined_plots <- lapply(cluster_chunks, function(chunk) {
    plot_list <- lapply(chunk, function(ident_level) {
      SpatialDimPlot(object, cells.highlight = WhichCells(object, idents = ident_level), cols.highlight = c("#FFFF00", "grey50")) + NoLegend() + ggtitle(ident_level)
    })
    wrap_plots(plot_list, ncol = length(plot_list)) +
      plot_layout(guides = 'collect') +
      plot_annotation(theme = theme(plot.margin = unit(rep(-0.5, 4), "lines")))
  })
  
  final_plot <- wrap_plots(combined_plots, ncol = 1)
  return(final_plot)
}

p <- plot_cluster_grid(object,ident = "seurat_cluster.projected")
p
```
```{r heatmap, fig.height = 10}
DefaultAssay(object) <- "Spatial.008um"
Idents(object) <- "seurat_cluster.projected"
object_subset <- subset(object, downsample=1000)
object_subset <- BuildClusterTree(object_subset, assay = "Spatial.008um", reduction = "pca.008um", reorder = T, verbose = TRUE)

Idents(object_subset) <- "seurat_cluster.projected"
markers <- FindAllMarkers(object_subset, assay = 'Spatial.008um', only.pos = TRUE)
markers %>%
    group_by(cluster) %>%
    dplyr::filter(avg_log2FC > 1) %>%
    slice_head(n = 5) %>%
    ungroup() -> top5

p <- DoHeatmap(object_subset, features = top5$gene, group.by = 'seurat_cluster.projected', size = 2.5) + NoLegend()
p
```

## Spatial neighborhood identification with BANKSY

```{r banksy}
#remotes::install_github('jleechung/seurat-wrappers&#64;feat-aft')
#remotes::install_github("prabhakarlab/Banksy&#64;devel")
library(SeuratWrappers)
library(Banksy)
```

Here, users can adjust the `k_geom` parameter to alter the number of neighbors that BANKSY looks for when defining a niche neighborhood. 

```{r banksy.run}
object <- RunBanksy(object, lambda = 0.8, verbose=TRUE, 
                      assay = 'Spatial.008um', slot = 'data', features = 'variable',
                      k_geom = 50)
```
```{r banksy.preprocess}
DefaultAssay(object) <- "BANKSY"
object <- RunPCA(object, assay = 'BANKSY', reduction.name = "pca.banksy", features = rownames(object), npcs = 30)
object <- RunUMAP(object, reduction = "pca.banksy", reduction.name = "umap.banksy", dims = 1:30)
object <- FindNeighbors(object, reduction = "pca.banksy", dims = 1:30)
object <- FindClusters(object, cluster.name = "banksy_cluster", resolution = 0.5)
```
```{r banksy.plot}
Idents(object) <- "banksy_cluster"
p <- SpatialDimPlot(object, group.by="banksy_cluster",label=T, repel=T) 
p
```

```{r banksy.cluster.plot, fig.height = 10}
p <- plot_cluster_grid(object, ident = "banksy_cluster")
p
```

## Subset out anatomical regions 

```{r subset1}
cortex.coordinates <- as.data.frame(read.csv('/brahms/lis/visium_hd/final_mouse/cortex-hippocampus_coordinates.csv'))
cortex.coordinates["cell"] <- "cortex"
colnames(cortex.coordinates) <- c("x", "y", "cell")

cortex <- CreateSegmentation(cortex.coordinates)
object[["cortex"]] <- Overlay(object[["slice1.008um"]], cortex)
cortex <- subset(object, cells=Cells(object[['cortex']]))
```

## Spatial deconvolution using RCTD

```{r install.rctd}
# devtools::install_github("dmcable/spacexr", build_vignettes = FALSE)
library(spacexr)
```

```{r sketch.cortex}
DefaultAssay(cortex) <- "Spatial.008um"
cortex <- NormalizeData(cortex)
cortex <- FindVariableFeatures(cortex)
cortex <- RunPCA(cortex, reduction.name = "pca.cortex") 
cortex <- FindNeighbors(cortex, reduction = "pca.cortex", dims = 1:30)
cortex <- RunUMAP(cortex, reduction = "pca.cortex", reduction.name = "umap.cortex", dims = 1:30)

cortex <- SketchData(
  object = cortex,
  ncells = 50000,
  method = "LeverageScore",
  sketched.assay = "sketch"
)
```

```{r sketch.cortex.preprocess}
DefaultAssay(cortex) <- "sketch"
cortex <- ScaleData(cortex)
cortex <- RunPCA(cortex, assay="sketch", reduction.name = "pca.cortex.sketch", verbose = T)
cortex <- FindNeighbors(cortex, reduction = "pca.cortex.sketch", dims = 1:30)
cortex <- RunUMAP(cortex, reduction = "pca.cortex.sketch", reduction.name = "umap.cortex.sketch", return.model = T, dims = 1:30, verbose = T)
```

```{r sc.data}
ref <- readRDS("/brahms/lis/visium_hd/mouse/visiumV2/allen_ref_withsketchumap.rds")
```

```{r rctd.setup, warning=FALSE, results=FALSE}
Idents(ref) <- "subclass_label"

DefaultAssay(ref) <- "sketch"
counts <- ref[["sketch"]]$counts
cluster <- as.factor(ref$subclass_label[Cells(ref[['sketch']])])
names(cluster) <- colnames(ref[['sketch']])

# remove cell types with less than 25 cells
valid_cells <- colnames(counts)[table(cluster)[cluster] >= 25]
filtered_counts <- counts[, valid_cells]

ref$nCount_sketch <- colSums(x = filtered_counts)
nUMI <- ref$nCount_sketch[!is.na(ref$nCount_sketch)]
cluster <- as.factor(cluster[colnames(filtered_counts)])
levels(cluster) <- gsub("/", "-", levels(cluster))
cluster <- droplevels(cluster)

reference <- Reference(counts, cluster, nUMI)

counts_hd <- cortex[["sketch"]]$counts
cortex_cells_hd <- colnames(cortex[["sketch"]])
coords <- GetTissueCoordinates(cortex)
coords <- coords[cortex_cells_hd,]
colnames(coords) <- c("x", "y")
coords[is.na(colnames(coords))] <- NULL

query <- SpatialRNA(coords, counts_hd, colSums(counts_hd))
```

```{r run.rctd, warning=FALSE, results=FALSE, eval=FALSE}
RCTD <- create.RCTD(query, reference, max_cores = 28)
RCTD <- run.RCTD(RCTD, doublet_mode = "doublet")
cortex <- AddMetaData(cortex, metadata = RCTD&#64;results$results_df)
```
```{r project.rctd}
cortex$first_type <- as.character(cortex$first_type)
cortex$first_type[is.na(cortex$first_type)] <- 'Unknown'
cortex <- ProjectData(
  object = cortex,
  assay = "Spatial.008um",
  full.reduction = "pca.cortex",
  sketched.assay = "sketch",
  sketched.reduction = "pca.cortex.sketch",
  umap.model = "umap.cortex.sketch",
  dims = 1:50,
  refdata = list(full_first_type = "first_type")
)
```
```{r rctd_results, fig.height=8, eval=FALSE}
DefaultAssay(object) <- "Spatial.008um"
object[[]][, "cortex_first_type"] <- "Unknown"
object$cortex_first_type[Cells(cortex)] <- cortex$full_first_type[Cells(cortex)]

p <- SpatialDimPlot(object, images="slice1.008um", group.by = "cortex_first_type", label=T, repel=T, label.size = 2) 
p
```

## Spatial neighborhood identification with BuildNicheAssay

```{r build.niches}
DefaultAssay(object) <- "Spatial.008um"
neighbors <- 200
object <- BuildNicheAssay(object = object, fov = "slice1.008um", group.by = "cortex_first_type", niches.k = 20, neighbors.k = neighbors)
```
```{r niches.plot}
p <- SpatialDimPlot(object, group.by="niches", label=T, repel=T)
p
```

## Analysis

Labeling niches/Banksy clusters as layers
```{r celltype.plot, fig.height = 12}
# decide whether to use niches or Banksy clusters to define layers 
excitatory_neurons <- c("L6 CT CTX","L2 IT ENTl","L5-6 NP CTX","L4-5 IT CTX","L5 IT CTX","L6b CTX", "L2-3 IT ENTl", "L4 RSP-ACA", "L2-3 IT CTX", " L5 PT CTX", "L6 IT CTX", "L2-3 IT PPP", "L5-6 IT TPE-ENT", "L6b-CT ENT", "L3 IT ENT", "L2 IT ENTm", "L5 PPP", "L2-3 IT RHP", "L6 IT ENTl")

plot_cell_types <- function(data, label) {
  p <- ggplot(data, aes(x = get(label), y = n, fill = cortex_first_type)) +
    geom_bar(stat = "identity", position = "stack") +
    geom_text(aes(label = ifelse(n >= min_count_to_show_label, cortex_first_type, "")),
              position = position_stack(vjust = 0.5), size = 2) +
    xlab(label) +
    ylab("Number of Cells") +
    ggtitle(paste0("Distribution of Cell Types across ", label)) +
    theme_minimal()
}

cell_type_banksy_counts <- object[[]] %>%
  dplyr::filter(cortex_first_type %in% excitatory_neurons) %>%
  dplyr::count(cortex_first_type, banksy_cluster)

cell_type_niche_counts <- object[[]] %>%
  dplyr::filter(cortex_first_type %in% excitatory_neurons) %>%
  dplyr::count(cortex_first_type, niches)

min_count_to_show_label <- 50

p1 <- plot_cell_types(cell_type_banksy_counts, "banksy_cluster")
p2 <- plot_cell_types(cell_type_niche_counts, "niches")
p1/p2
```
```{r layer.label}
# label layers
excitatory_neurons_subset <- object[[]][object$cortex_first_type %in% excitatory_neurons, ]
contingency_table <- table(excitatory_neurons_subset$cortex_first_type, excitatory_neurons_subset$banksy_cluster)
cluster_types <- apply(contingency_table, 2, function(x) names(which.max(x)))
match <- as.data.frame(cluster_types[match(object$banksy_cluster, names(cluster_types))], row.names = rownames(object[[]]))
colnames(match) <- "layer"
object$layer <- match$layer
```
```{r prop.plot}
# create barplot to show proportions of cell types of interest
neurons <- c("Lamp5", "Sst", "Pvalb", "Sst Chodl", "Sncg", "Vip", "Oligo", "Astro")
neuron_props <- reshape2::melt(prop.table(table(object$cortex_first_type, object$layer)[neurons,], margin = 1))
ggplot(neuron_props, aes(x = Var1, y = value, fill = Var2)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(x = "Cell type", y = "Proportion", fill = "Layer") +
  theme_classic()
```

```{r oligo, fig.height = 14}
DefaultAssay(object) <- "Spatial.008um"

Idents(object) <- "cortex_first_type"
oligo_cells <- WhichCells(object, ident = "Oligo")

Idents(object) <- "layer"
oligo_l2 <- intersect(oligo_cell