---
title: "Sketch clustering in mouse brain"
output: html_notebook
---
 
```{r setup, include=FALSE}
all_times <- list()  # store the time for each chunk
knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      now <<- Sys.time()
    } else {
      res <- difftime(Sys.time(), now, units = "secs")
      all_times[[options$label]] <<- res
    }
  }
}))
knitr::opts_chunk$set(
  tidy = TRUE,
  tidy.opts = list(width.cutoff = 95),
  message = FALSE,
  warning = FALSE,
  time_it = TRUE,
  error = TRUE
)
```

## load library
```{r, warning=FALSE, message=FALSE}
library(Seurat)
library(BPCells)
```
 
## load data from h5ad 
```{r, warning=FALSE, message=FALSE}
t0_CreateObject <- system.time({
  mat <- open_matrix_dir("../data/mouse_1M_neurons_counts")
  mat <- Azimuth::ConvertEnsembleToSymbol(mat = mat, species = 'mouse')
  options(Seurat.object.assay.version = "v5",  Seurat.object.assay.calcn = T)
  obj <- CreateSeuratObject(counts = mat)
})

```

## create sketch assay
```{r, warning=FALSE, message=FALSE}
t1_CreateSketchAssay <- system.time({
obj <- NormalizeData(obj)
obj <- FindVariableFeatures(obj, layer = 'counts')
obj <- LeverageScore(obj)
obj <- LeverageScoreSampling(object = obj, ncells = 50000, cast = 'dgCMatrix')
 
})

```
## Sketch assay clustering
```{r, warning=FALSE, message=FALSE}
t2_SketchClustering <- system.time({
obj <- FindVariableFeatures(obj)
obj <- ScaleData(obj)
obj <- RunPCA(obj)
obj <- FindNeighbors(obj, dims = 1:50)
obj <- FindClusters(obj)
})

obj <- RunUMAP(obj, dims = 1:50, return.model = T)
```

```{r}
DimPlot(obj, label = T, reduction = 'umap') + NoLegend() 
```
## Azimuth mapping to annotate clusters
```{r, warning=F, message=F}
 
 
options(Seurat.object.assay.version = "v3",  Seurat.object.assay.calcn = T)
obj.v3 <- CreateSeuratObject(counts =  as.sparse(obj[['RNA']]$counts[,colnames(obj[['sketch']])]) )
library(Azimuth)
obj.v3 <- RunAzimuth(query = obj.v3, assay = 'RNA', reference = 'mousecortexref', do.adt = F) 

obj$predicted.subclass <- obj.v3$predicted.subclass
obj$predicted.cluster <- obj.v3$predicted.cluster

```



```{r}
DimPlot(obj, reduction = 'umap', label = T) + NoLegend()
DimPlot(obj, reduction = 'umap', group.by = 'predicted.subclass',label = T) + NoLegend()
DimPlot(obj, reduction = 'umap', group.by = 'predicted.cluster',label = T) + NoLegend()
 
```
```{r,fig.height = 20, fig.width = 15}
features.set <- c('Aqp4', 'Sox10', 'Slc17a7', 'Aif1', 'Foxj1', 'Pax6', 'Slc17a6', 'Lum', 'Nanog', 'Gad2', 'Foxj1',   'Cldn5','Alas2')
features.gaba.set <- c('Gad1','Mef2c','Sst','Lhx6','Nr2f2','Prox1') 
DefaultAssay(obj) <- 'sketch'
FeaturePlot(obj, reduction = 'umap', features = features.set, max.cutoff = "q99", min.cutoff = 'q1')
FeaturePlot(obj, reduction = 'umap', features = features.gaba.set, max.cutoff = "q99", min.cutoff = 'q1')

```

## Project full cells to PCA from sketch assay 
```{r, warning=FALSE, message=FALSE}
t3_ProjectEmbedding <- system.time({
  ref.emb <- ProjectCellEmbeddings(query = obj,
                                   reference = obj,
                                   query.assay = 'RNA',
                                   reference.assay = 'sketch',
                                                reduction = 'pca')
obj[['pca.orig']] <- CreateDimReducObject(embeddings = ref.emb, assay = 'RNA')
DefaultAssay(obj) <- 'RNA'
})



``` 

## Transfer labels and umap from sketch to full data
```{r, warning=FALSE, message=FALSE}
t4_transferLabel <- system.time({
   options(future.globals.maxSize = 1e9)
  obj <- TransferSketchLabels(object = obj,
                            atoms = 'sketch',
                            reduction = 'pca.orig',
                            dims = 1:50,
                            refdata = list(cluster_full = 'sketch_snn_res.0.8',
                                        subclass_full ='predicted.subclass',
                                       cluster_anno_full  = 'predicted.cluster'),
                            reduction.model = 'umap'
                            )
})

```


```{r}
library(ggplot2)
DimPlot(obj, label = T, reduction = 'ref.umap', group.by = 'predicted.subclass_full', alpha = 0.1) + NoLegend()  

DimPlot(obj, label = T, reduction = 'ref.umap', group.by = 'predicted.cluster_anno_full', alpha = 0.1) + NoLegend()  

```

```{r}
all_T  <- ls(pattern = '^t')
overall <- sum(sapply(all_T, function(x) round(get(x)['elapsed'], digits = 3)))/60


for (i in 1:length(all_T)) {
  time.i <- get(all_T[i])['elapsed']
  if (time.i > 60) {
     print(paste(all_T[i], round(time.i/60, digits = 1), 'mins'))
  } else {
     print(paste(all_T[i], round(time.i, digits = 1), 'secs'))
  }
}
print(paste('Total time ', round(overall, digits = 3), 'mins' ))
 
```


```{r}

obj[['pca.nn']] <- Seurat:::NNHelper(data = obj[['pca.orig']]@cell.embeddings[,1:50], 
                            k = 30, 
                            method = "hnsw", 
                            metric = "cosine", 
                            n_threads = 10)
obj <- RunUMAP(obj, nn.name = "pca.nn", reduction.name = 'umap.orig', reduction.key = 'Uo_')
 
```

```{r}
DimPlot(obj, label = T, reduction = 'umap.orig', group.by = 'predicted.subclass_full', alpha = 0.1) + NoLegend()
DimPlot(obj, label = T, reduction = 'umap.orig', group.by = 'predicted.cluster_anno_full', alpha = 0.1) + NoLegend()
```